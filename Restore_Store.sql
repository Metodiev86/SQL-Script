-----------------------------------------------------------
-- РЕМОНТЕН СКРИПТ: Възстановяване на таблица STORE
-- Цел: пълно преизчисляване на складовите наличности
-- от таблица OPERATIONS и подравняване към правилния вид
-- Автор: (Твоето име / дата)
-----------------------------------------------------------

-- 1. Изчистваме всички текущи записи от таблица STORE.
-- Това занулява наличностите и подготвя място за ново
-- изчисление от OPERATIONS.
DELETE FROM store;

-----------------------------------------------------------
-- 2. Вкарваме новоизчислени редове в STORE:
--    - За всяка комбинация Обект (магазин/склад) + Стока
--    - Количеството (Qtty) се изчислява като сбор от всички
--      движения в OPERATIONS (Qtty * Sign)
--    - Взимаме последната цена за стоката (PriceIn от GOODS)
--    - Lot и LotID са фиксирани стойности тук (няма партиди)
-----------------------------------------------------------
INSERT INTO store (ObjectID, GoodID, Qtty, Price, Lot, LotID)
SELECT
    ob.ID AS ObjectID,
    g.ID AS GoodID,
    (
        SELECT ISNULL(SUM(Qtty * Sign), 0)
        FROM operations
        WHERE objectID = ob.ID
          AND goodID   = g.ID
    ) AS Qtty,
    g.PriceIn AS Price,
    ' '       AS Lot,    -- Празен Lot (няма партиди)
    1         AS LotID   -- Фиксирана партида с ID=1
FROM goods g, objects ob;

-----------------------------------------------------------
-- 3. Обновяваме колоната LotOrder със стойността на ID.
--    Това осигурява правилен ред на записите при работа
--    с Lot системата (дори да е фиктивна тук).
-----------------------------------------------------------
UPDATE store
SET LotOrder = ID;

-----------------------------------------------------------
-- 4. Нулираме количества за стоки от специфични типове.
--    В таблица GOODS има типове (Type), където:
--    - Type 0, 1, 6, 12 = нормални стоки (остават)
--    - всички други Type ≠ (0,1,6,12) -> не се държат
--      в наличност, затова Quantity се занулява.
-----------------------------------------------------------
UPDATE store
SET Qtty = 0
WHERE GoodID IN (
        SELECT ID FROM goods
        WHERE Type NOT IN (0, 1, 6, 12)
      )
  AND Qtty <> 0;

-----------------------------------------------------------
-- Край на ремонтния скрипт
-- Резултат: STORE е напълно преизчислен от OPERATIONS.
-----------------------------------------------------------
